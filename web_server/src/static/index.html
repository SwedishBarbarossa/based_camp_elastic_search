<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Based Camp Semantic Search</title>
    <link rel="stylesheet" href="/static/style.css">
    <script>
        async function search(q_type) {
            // Get query from the called search bar
            let query = "";
            if (q_type == 'sym') {
                query = document.getElementById('search-query-sym').value;
            } else if (q_type == 'asym') {
                query = document.getElementById('search-query-asym').value;
            }

            // Get channels selected from radios
            const channels = [
                "based_camp",
                "balaji_srinivasan",
                "hormozis",
                "y_combinator",
            ];
            let selected_channels = [];
            for (i = 0; i < channels.length; i++) {
                if (document.getElementById(channels[i]).checked) {
                    selected_channels.push(channels[i]);
                }
            }
            if (selected_channels.length == 0) {
                selected_channels = channels;
            }
            const channels_string = selected_channels.join(",");

            let response = await fetch(`/search/?query=${query}&channels=${channels_string}&q_type=${q_type}`);
            let data = await response.json();
    
            let resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = ''; // Clear previous results
    
            // Process results to sort by score
            let segments = Object.keys(data.results).map(idx => {
                const segment = data.results[idx];
                const [videoId, start, end, score] = segment;
                return { videoId, start, end, score };
            }).sort((a, b) => b.score - a.score);

            segments.forEach(({ videoId, start, end, score }) => {
                const videoLink = `https://www.youtube.com/watch?v=${videoId}&t=${start}s`;
                const embedLink = `https://www.youtube.com/embed/${videoId}?start=${start}`;
    
                // Entry container
                let entryContainer = document.createElement("div");
                entryContainer.className = "entry-container";
    
                // Container for score and buttons
                let controlsContainer = document.createElement("div");
                controlsContainer.className = "controls-container";
    
                // Score display
                let scoreDisplay = document.createElement("div");
                scoreDisplay.textContent = `Score: ${score.toFixed(3)}`;
    
                // Copy link button
                let copyBtn = document.createElement("button");
                copyBtn.textContent = "Copy Link";
                copyBtn.style.position = "relative"; // Needed to position the notification correctly
                copyBtn.onclick = function() {
                    navigator.clipboard.writeText(videoLink).then(() => {
                        // Create the notification element
                        let notification = document.createElement("div");
                        notification.textContent = "Copied!";
                        notification.className = "notification";

                        // Append and remove the notification after 1 seconds
                        copyBtn.appendChild(notification);
                        setTimeout(() => notification.remove(), 1000);
                    });
                };
    
                // Toggle embed button
                let toggleEmbedBtn = document.createElement("button");
                toggleEmbedBtn.textContent = "Show/Hide Video";
                let iframe;
                toggleEmbedBtn.onclick = function() {
                    if (!iframe) {
                        iframe = document.createElement("iframe");
                        iframe.setAttribute("width", "560");
                        iframe.setAttribute("height", "315");
                        iframe.setAttribute("src", embedLink);
                        iframe.setAttribute("title", "YouTube video player");
                        iframe.setAttribute("frameborder", "0");
                        iframe.setAttribute("allow", "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share");
                        iframe.setAttribute("allowfullscreen", "true");
                        iframe.setAttribute("referrerpolicy", "strict-origin-when-cross-origin");
                        entryContainer.appendChild(iframe);
                        entryContainer.classList.add("open");
                    } else {
                        iframe.remove();
                        iframe = null;
                        entryContainer.classList.remove("open");
                    }
                };
    
                // Append score and buttons to controls container
                controlsContainer.appendChild(scoreDisplay);
                controlsContainer.appendChild(copyBtn);
                controlsContainer.appendChild(toggleEmbedBtn);
    
                // Append controls container to entry container
                entryContainer.appendChild(controlsContainer);
    
                // Append entry container to results
                resultsDiv.appendChild(entryContainer);
            });
        }
    
        function handleKeyPressSym(event) {
            if (event.keyCode === 13 || event.which === 13) {
                search('sym');
            }
        }

        function handleKeyPressAsym(event) {
            if (event.keyCode === 13 || event.which === 13) {
                search('asym');
            }
        }
    
        window.onload = function() {
            document.getElementById('search-query-sym').addEventListener('keypress', handleKeyPressSym);
            document.getElementById('search-query-asym').addEventListener('keypress', handleKeyPressAsym);
        };
    </script>
    
</head>
<body>
    <div class="search-bar-container">
        <h1>YouTube Channel Search Indexer</h1>
        <div>
            <h2>Search Similar Phrase</h2>
            <input type="text" id="search-query-sym" placeholder="Enter phrase" class="search-bar">
            <button onclick="search('sym')">Search</button>
        </div>
        <div>
            <h2>Search Answer to Question</h2>
            <input type="text" id="search-query-asym" placeholder="Enter question" class="search-bar">
            <button onclick="search('asym')">Search</button>
        </div>
        <div>
            <h2>Select Channels</h2>
            <div class="channels-container">
                <div class="channel-container">
                    <label for="based_camp">Based Camp</label>
                    <input type="checkbox" id="based_camp" class="channel-checkbox" value="based_camp">
                </div>
                <div class="channel-container">
                    <label for="balaji_srinivasan">Balaji Srinivasan</label>
                    <input type="checkbox" id="balaji_srinivasan" class="channel-checkbox" value="balaji_srinivasan">
                </div>
                <div class="channel-container">
                    <label for="hormozis">Hormozis</label>
                    <input type="checkbox" id="hormozis" class="channel-checkbox" value="hormozis">
                </div>
                <div class="channel-container">
                    <label for="y_combinator">Y Combinator</label>
                    <input type="checkbox" id="y_combinator" class="channel-checkbox">
                </div>
            </div>
        </div>
    </div>
    <div id="results" class="results-container">
        <!-- Results with video embeds and timestamp selectors will be displayed here -->
    </div>
</body>
</html>
